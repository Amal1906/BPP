<app-loader [isLoading]="isLoading"></app-loader>

<div class="modern-step-details-page">
  <div class="step-details-header modern-card">
    <div class="header-actions">
      <button class="action-btn-modern back-btn" title="Back" (click)="navigateBack()">
        <mat-icon>arrow_back</mat-icon>
        <span>Back</span>
      </button>
      <button class="action-btn-modern refresh-btn" title="Refresh" (click)="onRefresh()">
        <mat-icon>refresh</mat-icon>
        <span>Refresh</span>
      </button>
    </div>
  </div>

  <div class="stepper-section">
    <app-stepper [workFlow]="workFlow" [loading]="isLoading"></app-stepper>
  </div>

  <div class="step-details-content modern-card">
    <div class="content-header">
      <h3>Process Step Details</h3>
      <p>Detailed breakdown of each step in the automation process</p>
    </div>
    
    <div class="table-container">
      <div class="modern-table-wrapper">
        <table class="modern-table">
          <thead>
            <tr>
              <th>
                <div class="th-content">
                  <mat-icon>label</mat-icon>
                  Step Name
                </div>
              </th>
              <th>
                <div class="th-content">
                  <mat-icon>schedule</mat-icon>
                  Process Time
                </div>
              </th>
              <th>
                <div class="th-content">
                  <mat-icon>info</mat-icon>
                  Status
                </div>
              </th>
              <th>
                <div class="th-content">
                  <mat-icon>comment</mat-icon>
                  Comments
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let step of steps; let i = index" class="table-row" [class.even]="i % 2 === 0">
              <!-- Step Name -->
              <td class="step-name-cell">
                <div class="step-info">
                  <div class="step-number">{{ i + 1 }}</div>
                  <span>{{ step.step_name || 'No step name' }}</span>
                </div>
              </td>

              <!-- Process Time -->
              <td class="time-cell">
                <div class="time-info">
                  <mat-icon>access_time</mat-icon>
                  <span>{{
                    step.process_time
                      ? (step.process_time | formatDateTime : "MM-dd-yyyy, HH:mm:ss")
                      : "Not processed"
                  }}</span>
                </div>
              </td>

              <!-- Status -->
              <td class="status-cell">
                <div class="modern-status-badge"
                     [ngClass]="getStatusBadge(step.step_status).statusClass">
                  <mat-icon>{{ getStatusIcon(step.step_status) }}</mat-icon>
                  <span>{{ getStatusBadge(step.step_status).statusText }}</span>
                </div>
              </td>

              <!-- Comments + Document Analysis Button -->
              <td class="comments-cell">
                <div class="comment-content">
                  <!-- Document Analysis Step -->
                  <ng-container *ngIf="step.step_name?.toLowerCase() === 'document analysis'; else normalComment">
                    <span>{{ step.comments || 'No comments available' }}</span>
                    <button
                      *ngIf="step.step_status?.toLowerCase() === 'completed'"
                      class="download-btn view-docs-btn"
                      title="View Docs"
                      (click)="openDocumentAnalysis(step)"
                    >
                      <mat-icon>visibility</mat-icon>
                      View Docs
                    </button>
                  </ng-container>

                  <!-- Normal comment for other steps -->
                  <ng-template #normalComment>
                    <span>{{ step.comments || 'No comments available' }}</span>
                  </ng-template>
                </div>
              </td>
            </tr>

            <!-- Empty State -->
            <tr *ngIf="steps.length === 0" class="empty-row">
              <td colspan="4">
                <div class="empty-state">
                  <mat-icon>info_outline</mat-icon>
                  <span>No step details available</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="document-popup-overlay" *ngIf="showDocumentPopup" (click)="closeDocumentPopup()">
    <div class="document-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>{{ isEditMode ? 'Edit Documents' : 'Document List' }}</h3>
        <button class="close-btn" (click)="closeDocumentPopup()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="popup-body">
        <ng-container *ngIf="!isEditMode">
          <div class="document-list-view">
            <div class="document-item" *ngFor="let doc of documentList; let i = index">
              <div class="doc-icon">
                <mat-icon>description</mat-icon>
              </div>
              <span>{{ doc }}</span>
            </div>
            <div class="empty-state" *ngIf="documentList.length === 0">
              <mat-icon>folder_open</mat-icon>
              <p>No documents available</p>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="isEditMode">
          <div class="edit-mode-content">
            <div class="form-section">
              <label class="form-label">Source Document</label>
              <select class="form-select" [(ngModel)]="selectedSourceDocument">
                <option value="">Select a source document</option>
                <option *ngFor="let doc of availableDocuments" [value]="doc">{{ doc }}</option>
              </select>
            </div>

            <div class="form-section">
              <div class="label-with-action">
                <label class="form-label">Target Documents</label>
                <button class="add-target-btn" (click)="addTargetDocument()">
                  <mat-icon>add</mat-icon>
                  Add Target
                </button>
              </div>

              <div class="target-documents-list">
                <div class="target-item" *ngFor="let target of selectedTargetDocuments; let i = index; trackBy: trackByIndex">
                  <select class="form-select" [(ngModel)]="selectedTargetDocuments[i]">
                    <option value="">Select a target document</option>
                    <option *ngFor="let doc of availableDocuments" [value]="doc">{{ doc }}</option>
                  </select>
                  <button class="remove-btn" (click)="removeTargetDocument(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>

                <div class="empty-state-small" *ngIf="selectedTargetDocuments.length === 0">
                  <p>Click "Add Target" to add target documents</p>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <div class="popup-footer">
        <button class="footer-btn close-footer-btn" (click)="closeDocumentPopup()">
          <mat-icon>close</mat-icon>
          Close
        </button>
        <button class="footer-btn edit-btn" *ngIf="!isEditMode" (click)="openEditMode()">
          <mat-icon>edit</mat-icon>
          Edit
        </button>
        <button class="footer-btn save-btn" *ngIf="isEditMode" (click)="saveDocumentChanges()">
          <mat-icon>save</mat-icon>
          Save
        </button>
      </div>
    </div>
  </div>
</div>
